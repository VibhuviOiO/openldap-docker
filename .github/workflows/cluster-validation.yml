name: Cluster Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-single-node:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image
        run: docker build -t openldap:test .

      - name: Start single node
        run: docker-compose -f docker-compose.single-node.yml up -d

      - name: Wait for initialization
        run: sleep 15

      - name: Test connectivity
        run: |
          docker exec openldap-single ldapsearch -x -H ldap://localhost:389 \
            -b "dc=example,dc=com" \
            -D "cn=Manager,dc=example,dc=com" \
            -w admin -LLL

      - name: Verify base structure
        run: |
          docker exec openldap-single ldapsearch -x -H ldap://localhost:389 \
            -b "ou=People,dc=example,dc=com" \
            -D "cn=Manager,dc=example,dc=com" \
            -w admin -LLL

      - name: Show logs
        if: failure()
        run: docker logs openldap-single

      - name: Cleanup
        if: always()
        run: docker-compose -f docker-compose.single-node.yml down -v

  test-multi-master:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image
        run: docker build -t openldap:test .

      - name: Start cluster
        run: docker-compose -f docker-compose.multi-master.yml up -d

      - name: Wait for initialization
        run: sleep 20

      - name: Test node connectivity
        run: |
          for port in 389 390 391; do
            docker exec ldap-node1 ldapsearch -x -H ldap://localhost:$port \
              -b "dc=example,dc=com" \
              -D "cn=Manager,dc=example,dc=com" \
              -w admin -LLL || exit 1
          done

      - name: Test replication
        run: |
          # Add entry to node1
          docker exec ldap-node1 ldapadd -x -H ldap://localhost:389 \
            -D "cn=Manager,dc=example,dc=com" -w admin <<EOF
          dn: uid=testuser,ou=People,dc=example,dc=com
          objectClass: inetOrgPerson
          uid: testuser
          cn: Test User
          sn: User
          EOF
          
          sleep 5
          
          # Check on node2
          docker exec ldap-node2 ldapsearch -x -H ldap://localhost:389 \
            -b "dc=example,dc=com" "(uid=testuser)" | grep "dn: uid=testuser"

      - name: Show logs
        if: failure()
        run: |
          docker logs ldap-node1
          docker logs ldap-node2
          docker logs ldap-node3

      - name: Cleanup
        if: always()
        run: docker-compose -f docker-compose.multi-master.yml down -v
